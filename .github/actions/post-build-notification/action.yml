name: Post Build Notification
description: Posts a build status comment on Pull Requests.

inputs:
  build_result:
    description: "The result of the build job (success, failure, etc.)"
    required: true
  version:
    description: "The version that was built"
    required: false
    default: "N/A"
  image_name:
    description: "The full image name without tags (e.g. w90vyjm8.c1.bhs5.container-registry.ovh.net/cv.coderbunker.ca/modern-resume)"
    required: false
  tags:
    description: "Newline separated list of tags pushed"
    required: false
  github_token:
    description: "GitHub Token for posting comments"
    required: true

runs:
  using: "composite"
  steps:
    - name: Post Comment
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const { owner, repo } = context.repo;
          const buildResult = '${{ inputs.build_result }}';
          const version = '${{ inputs.version }}';
          const imageName = '${{ inputs.image_name }}';
          const tagsInput = `${{ inputs.tags }}`;

          let resultIcon = 'â“ **Unknown**';
          if (buildResult === 'success') resultIcon = 'âœ… **Success**';
          else if (buildResult === 'failure') resultIcon = 'âŒ **Failed**';
          else if (buildResult === 'skipped') resultIcon = 'â­ï¸ **Skipped**';
          else if (buildResult === 'cancelled') resultIcon = 'ðŸš« **Cancelled**';

          // Only post on PRs
          if (!context.issue.number) {
            console.log("Not a Pull Request, skipping comment.");
            return;
          }

          let commitMessage = "Unknown commit";
          let failureDetails = "";
          let successDetails = "";

          try {
            // Fetch commit message
            const commitInfo = await github.rest.repos.getCommit({
              owner,
              repo,
              ref: context.sha
            });
            // Get just the first line of the commit message
            commitMessage = commitInfo.data.commit.message.split('\n')[0];
          } catch (e) {
            console.error("Failed to fetch commit message:", e);
          }

          // If the build failed, try to find exactly which step failed
          if (buildResult === 'failure') {
            try {
              const jobs = await github.rest.actions.listJobsForWorkflowRun({
                owner,
                repo,
                run_id: context.runId
              });

              // Find the first failing job
              const failedJob = jobs.data.jobs.find(j => j.conclusion === 'failure');

              if (failedJob) {
                // Find the specific step that failed
                const failedStep = failedJob.steps.find(s => s.conclusion === 'failure');
                const stepName = failedStep ? failedStep.name : "Unknown Step";

                failureDetails = `\n- **Failing Job**: \`${failedJob.name}\` -> Step: \`${stepName}\``;
                failureDetails += `\n- **Logs**: [View detailed logs here](${failedJob.html_url})`;
              }
            } catch (e) {
              console.error("Failed to fetch job details:", e);
              failureDetails = `\n- **Logs**: [View workflow run here](https://github.com/${owner}/${repo}/actions/runs/${context.runId})`;
            }
          }

          // If build succeeded and image details were provided
          if (buildResult === 'success' && imageName) {
            // Create Harbor web URL strictly based on known conventions
            // Format: https://w90vyjm8.c1.bhs5.container-registry.ovh.net/harbor/projects/3/repositories/modern-resume-admin/artifacts-tab
            let harborUrl = "";
            if (imageName.includes("w90vyjm8.c1.bhs5.container-registry.ovh.net/cv.coderbunker.ca/")) {
              const harborRepoPath = imageName.replace("w90vyjm8.c1.bhs5.container-registry.ovh.net/cv.coderbunker.ca/", "");
              harborUrl = `https://w90vyjm8.c1.bhs5.container-registry.ovh.net/harbor/projects/3/repositories/${harborRepoPath}/artifacts-tab`;
            }

            successDetails += `\n\n### ðŸ“¦ Docker Artifacts\n`;
            if (harborUrl) {
              successDetails += `[View in Harbor Registry](${harborUrl})\n\n`;
            }

            // Reconstruct tags string (actions format multiline weirdly)
            const tags = tagsInput.split('\\n').filter(t => t.trim().length > 0);

            // To figure out the safest tag to pull, usually the environment/pr-specific one
            let pullTag = version;

            if (tags.length > 0) {
              successDetails += `**Generated Tags:**\n`;
              // Convert full tags like "registry/image:1.2.3" to just "1.2.3" for display,
              // or handle if they are passed as raw tags.
              tags.forEach(t => {
                const parts = t.split(':');
                const rawTag = parts.length > 1 ? parts[parts.length - 1] : t;
                successDetails += `- \`${rawTag}\`\n`;
                // Prefer the PR specific tag if we find one
                if (rawTag.includes('pr-')) {
                   pullTag = rawTag;
                }
              });
            }

            successDetails += `\n**Pull Instructions:**\n`;
            successDetails += "```bash\n";
            successDetails += `docker pull ${imageName}:${pullTag}\n`;
            successDetails += "```\n";
          }

          const body = `### Build Status: ${resultIcon}\n\n` +
            `- **Workflow**: [${context.workflow}](https://github.com/${owner}/${repo}/actions/runs/${context.runId})\n` +
            `- **Commit**: ${commitMessage}\n` +
            `- **Version**: \`${version}\`\n` +
            `- **Ref**: \`${context.ref}\` (\`${context.sha.substring(0, 7)}\`)` +
            `${failureDetails}${successDetails}\n\n` +
            `*Generated by Modern Resume CI Service*`;

          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: context.issue.number,
            body
          });
