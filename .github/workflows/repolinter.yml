name: Repolinter

on:
  workflow_call:

jobs:
  lint-repo:
    name: Repository Topology Linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          path: target-repo

      - name: Checkout Environment Repository
        uses: actions/checkout@v4
        with:
          repository: coderbunker/modern-resume-env
          token: ${{ secrets.GITHUB_TOKEN }}
          path: env-repo
          ref: main

      - name: Setup Environment
        uses: ./env-repo/.github/actions/setup-env
        with:
          github_access_token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          install_deps: "false"
          working_directory: target-repo

      - name: Run Actionlint
        run: bunx actionlint
        working-directory: target-repo

      - name: Check Non-Western Characters
        shell: bash
        run: |
          cd target-repo
          # Use git ls-files to get all tracked files, excluding binary ones if possible
          # We xargs them to the shared script
          git ls-files | xargs ../env-repo/scripts/check-non-western.py

      - name: Check Pre-commit Configuration
        run: |
          cd target-repo
          ../env-repo/.github/scripts/check-precommit-hooks.sh

      - name: Check Essential Files
        run: |
          cd target-repo
          HAS_ERROR=0

          echo "üîç Checking for essential repository files..."

          # Check for Nix Flake
          if [[ ! -f "flake.nix" ]]; then
              echo "::error file=flake.nix::Missing flake.nix in repository root. All repositories must use Nix."
              HAS_ERROR=1
          else
              echo "‚úÖ Found flake.nix"
          fi

          if [[ "$HAS_ERROR" -eq 1 ]]; then
              exit 1
          fi

      - name: Validate Nix Flake
        run: |
          cd target-repo
          nix flake check
